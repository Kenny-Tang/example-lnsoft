
# 设计方案

# 一. 背景与目标

## 背景
优化用户体验，减少用户对相似标书的重复工作量

## 目标
投标人在客户端对应标书模板进行结构化填报及编制并添加相应佐证附件，标书制作完毕后可一键生成结构化制式应答文件，并提供标书预览、电子版加密等功能，结构化模块化标书制作提高投标文件编制规范性，同时保证电子版应答文件和纸质版应答文件的信息一致性，推动了无纸化单轨制评审应用。

## 收益
预期功能的收益

# 二. 需求描述

## 名词解释
  
  **末级目录** ：没有子节点的节点

## 标书复用
投标人可以引用历史的投标文件及资质信息，快速生成一版投标文件
![663063044515069961.png](res/663063044515069961.png)

![663063044515069959.png](res/663063044515069959.png)

### 测试用例

# 三. 系统架构设计

## 总体架构:
系统架构图

## 标书复用流程设计
功能的详细流程设计

### 选择复用的项目及分标

#### 选择复用的项目及分标 流程设计
选择复用的项目及分标，选择框。选择投标文件上传日志中，当前登录账号名称与上传日志中供应商名称一致的数据（项目-分标-虚拟分标一致），再选择当前电脑中存储的项目。

本次投标结构化目录展示：取当前选择的虚拟分标对应的目录。根据目录级次展示。

复用分标的结构化目录展示：取选择项目分标对应的数据库中存储的目录。根据目录级次展示。
![获取用户可复用的分标信息.png](res/%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%8F%AF%E5%A4%8D%E7%94%A8%E7%9A%84%E5%88%86%E6%A0%87%E4%BF%A1%E6%81%AF.png)
<div style="display:none">
```plantuml
@startuml
'https://plantuml.com/activity-diagram-beta
'选择投标文件上传日志中，当前登录账号名称与上传日志中供应商名称一致的数据（项目-分标-虚拟分标一致），再选择当前电脑中存储的项目。
title 获取用户可复用的分标信息
|客户端|
start
:FE Request;
|招投标管理|
:根据登录信息查找供应商可以服用的分标信息;
|客户端|
:获取供应商可以服用的分标的信息;
|本地服务|
:查找本地服务中可以复用的分标信息;
note right 
    携带查询得到的数据，
endnote
:取本地服务数据与远程服务数据的交集;
|客户端|
:获取供应商可以服用的分标的信息;
|客户端|
:初始化客服用分标信息列表;
:客户选择复用分标;
|本地服务|
:复用分标的结构化目录;
|客户端|
:待复用分标信息;
end
@enduml
```
</div>

#### 选择复用的项目及分标 系统交互时序图
功能的系统流程调用时序设计

### 标书复用自动关联
判断本次投标结构化目录 与复用分标的结构化目录中名称是否存在重名的目录，重名则自动关联

#### 自动关联 流程设计
![复用分标自动关联流程图.png](res/%E5%A4%8D%E7%94%A8%E5%88%86%E6%A0%87%E8%87%AA%E5%8A%A8%E5%85%B3%E8%81%94%E6%B5%81%E7%A8%8B%E5%9B%BE.png)
<div style="display:none">
```plantuml
title 复用分标自动关联流程图
start
:查询目标分标信息;
note right
目标分标的信息，在选择分标的时候已经确定
选择复用的项目及分标
endnote
:关联直接父级目录信息;
if (目录名称相同) is (是) then
:复用目录;
:客户端服务，保存服用的映射关系; 
endif 
end 
```
</div>

#### 手动关联 系统交互时序图
功能的系统流程调用时序设计

### 标书复用手动关联
判断本次投标结构化目录 与复用分标的结构化目录中名称是否存在重名的目录，重名则自动关联

#### 手动关联 流程设计
![复用标书手动关联流程图-.png](res/%E5%A4%8D%E7%94%A8%E6%A0%87%E4%B9%A6%E6%89%8B%E5%8A%A8%E5%85%B3%E8%81%94%E6%B5%81%E7%A8%8B%E5%9B%BE-.png)
<div style="display:none">

```plantuml
title 复用标书手动关联流程图
start
:右键选择简要关联的目录;
note right 
仅末级节点有关联选项
仅展示服用标书的同父级目录的子目录选项
endnote
:选择关联目录;
note 
   1. 初次关联，同时关联父级目录
   2. 关联其他子节点，只能关联同一父级目录下的子节点
   3. 更改父级目录，需要删除父级节点下所有的已关联的节点
endnote
if (类型是否一致) is  (否) then
    :提示 字段类型不一致无法关联;
    note
    类型： 文本 文本域 数字 日期 时间 下拉
    endnote
    stop; 
endif 
:关联直接父级节点关联关系;

end 
```
</div>

#### 手动关联 系统交互时序图
功能的系统流程调用时序设计

### 标书复用确认
#### 流程设计
![复用标书确认-.png](res/%E5%A4%8D%E7%94%A8%E6%A0%87%E4%B9%A6%E7%A1%AE%E8%AE%A4-.png)
<div style="display:none">

```plantuml
title 标书复用确认
|客户端|
start
:点击标书复用;
if (此操作将覆盖掉本分标同目录的文件内容，请确认是否导入?) is (否)
    :不复用;
    stop
endif
if (分标正在制作中) is (否)
:生成word;
note
    注意需要修改文件内容的部分
endnote
:标书状态修改为制作中;
:资质信息复用;

'关联项拷贝复用文件的对应资质信息（拷贝数据库中存储的资质信息），如果资质信息字段的文本格式不一致时（下拉框时需要判断下拉的内容是否一致），则不导入资质信息
:word文件复用; 
endif 
end
```
</div>

#### 系统交互时序图
### 批量扩展目录 
#### 流程设计
录入扩展数量则对应生成拓展目录，如扩展发票500个, 需同时生成同样的子目录

分标如果是未制作状态，则自动生成对应的word，状态修改为制作中

![批量扩展目录-.png](res/%E6%89%B9%E9%87%8F%E6%89%A9%E5%B1%95%E7%9B%AE%E5%BD%95-.png)
<div style="display:none">
```plantuml
title 批量扩展目录
|客户端|
start
:点击批量扩展目录;
:输入扩展目录数量;
:FE Request|
|招投标管理|
if (分标) is (未制作) then 
:生成word文件;
:修改状态为制作中;
endif 
:生成扩展目录及其子目录;
end 
```
</div>

#### 批量扩展目录 系统交互时序图
功能的系统流程调用时序设计

### 发票修改信息优化

### 上传标书，校验发票信息
1. 校验发票信息 （白名单不走校验接口）
2. 校验通过，上传发票信息

## 数据库设计

### ER图
![复用标书确认-.png](res/%E5%A4%8D%E7%94%A8%E6%A0%87%E4%B9%A6%E7%A1%AE%E8%AE%A4-.png)
<div style="display:none">

```plantuml

@startuml
skinparam linetype ortho

class ztb_reuse_catalog_rel  <<分标复用>>{
    id bigint 主键
    vid_bid_id 分标目录ID
    reuse_vid_bid_id 复用分标ID
    version 版本号
    udpate_by 更新人
    del_flag 删除标识
}

class ztb_reuse_catalog_rel_item <<复用目录关联关系>> {
    id 主键
    reuse_catalog_rel_id 复用关联关系ID
    leaves_id 目录ID 
    leaves_name 节点名称
    rel_leaves_id 复用目录ID
    rel_leaves_name 复用节点名称
    del_flag 删除标识
} 

ztb_reuse_catalog_rel_item o--> ztb_reuse_catalog_rel : reuse_catalog_rel_id -> id

@enduml
```
</div>

### 建表语句

用户表 (users)：记录用户基础信息，展示添加有效跨规则和选择型参数的提前小描述，及编码

## 接口设计
新增接口
### 复用分标目录关联关系查询
### 修改关联目标分标
### 查询可复用分标 招投标管理
### 查询可复用分标 本地服务
### saveOrUpdate 节点关联关系
### 标书复用 -- 复用数据
### 批量扩展 招投标管理
### 批量扩展 生成文件 本地服务
### 获取发票状态

修改
### 自动关联，返回关联关系

- URL：/getCatalogRel

- 方法：POST

- 请求参数

    ```json
      {"virBid": "目录关联ID"}
    ```

- 返回值

    ```json
      {"status": "成功","id": "目录关联ID", "leavesId": "节点ID", "relLeavesId": "复用节点ID", "relLeavesName": "复用节点名称"}
    ```

### 日志查询接口

- URL：/api/v1/logs

- 方法：GET

- 请求参数

    ```json
      {"start_date": "开始日期", "end_date": "结束日期"}
    ``` 

- 返回值

    ```json
      {"logs": ["日志列表"]}
    ```


